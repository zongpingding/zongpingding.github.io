

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/fluid_theme_pic/favicon.png">
  <link rel="icon" href="/fluid_theme_pic/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Eureka">
  <meta name="keywords" content="">
  
    <meta name="description" content="引入 宏展开是 LaTeX\rm\LaTeXLATE​X 中一个很重要的概念，为了引入这个概念，参加下面的例子: 12\def\cmda&#123;abc&#125;\uppercase&#123;\cmda&#125; 那么你猜猜，这段代码输出的结果是什么? abc ? ABC ?  结果是 abc. 我不是都让它uppercase了么？为什么还是没有uppercase，反而是给我直接输出了?">
<meta property="og:type" content="article">
<meta property="og:title" content="Expansion in TeX">
<meta property="og:url" content="https://zongpingding.github.io/2024/06/14/expansion_in_TeX/index.html">
<meta property="og:site_name" content="Eureka">
<meta property="og:description" content="引入 宏展开是 LaTeX\rm\LaTeXLATE​X 中一个很重要的概念，为了引入这个概念，参加下面的例子: 12\def\cmda&#123;abc&#125;\uppercase&#123;\cmda&#125; 那么你猜猜，这段代码输出的结果是什么? abc ? ABC ?  结果是 abc. 我不是都让它uppercase了么？为什么还是没有uppercase，反而是给我直接输出了?">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zongpingding.github.io/img/expansion_in_tex/output.png">
<meta property="og:image" content="https://zongpingding.github.io/img/expansion_in_tex/error_log.png">
<meta property="article:published_time" content="2024-06-14T08:44:36.570Z">
<meta property="article:modified_time" content="2024-09-26T17:15:56.319Z">
<meta property="article:author" content="Eureka">
<meta property="article:tag" content="expansion">
<meta property="article:tag" content="protect">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://zongpingding.github.io/img/expansion_in_tex/output.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Expansion in TeX - Eureka</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zongpingding.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Place of Eureka</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/fluid_theme_pic/default.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Expansion in TeX"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-06-14 16:44" pubdate>
          June 14, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.7k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          48 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Expansion in TeX</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="引入">引入</h2>
<p>宏展开是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\rm\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord"><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6833em;"><span style="top:-2.905em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span></span> 中一个很重要的概念，为了引入这个概念，参加下面的例子:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\def</span><span class="hljs-keyword">\cmda</span>&#123;abc&#125;<br><span class="hljs-keyword">\uppercase</span>&#123;<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>那么你猜猜，这段代码输出的结果是什么? abc ? ABC ?  结果是 abc. 我不是都让它uppercase了么？为什么还是没有uppercase，反而是给我直接输出了?</p>
<p>背后的原理就是宏展开, 下面我们来细说这个宏展开.</p>
<blockquote>
<p>个人感觉 <code>宏展开</code> 是可以和 <code>catcode</code> 并列的一个属于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>TeX</mtext></mrow><annotation encoding="application/x-tex">\rm\TeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord"><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> 的黑魔法, 用好了可以写出一些很 unbelievable 的代码.</p>
</blockquote>
<h2 id="LaTeX-2e">LaTeX 2e</h2>
<h3 id="simple-example">simple example</h3>
<p>先讲一下\expandafter的作用:  expand the <strong>first token</strong> after the <code>&#123;</code>.  所以下面的命令：</p>
 <figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>会先展开 { 后的第一个token，这个token就是\cmda, 于是\cmda被展开为 ‘abc’ , 从而就变成了 \uppercase{abc}了.</p>
<blockquote>
<p>TeX only uppercases explicit character tokens (using the <code>\uccode</code> table)</p>
</blockquote>
<p>The <code>\expandafter</code>  primitive expands the token after the next one, 所以上述的 the next one 就是 ‘{’， 而那个after的东西就是 \cmda.</p>
<blockquote>
<p>如果你的命令是 \uppercase\expandafter{abc\cmda}, 那么这个 \expandafter首先展开的其实是letter ‘a’,而不是macro \cmda. 毕竟\expandafter只负责展开它后面的第二个token (the token after the next one)</p>
</blockquote>
<h3 id="expanding-process">expanding process</h3>
<h4 id="expand-rule">expand rule</h4>
<p>一个\expandafter命令可以认为包含下面这三个步骤, 针对示例: \expandafter T\cmda</p>
<ul>
<li>首先把第一个token 'T’保存 (read: a\cmda)</li>
<li>然后展开第二个token ‘\cmda’ (\cmda -&gt; abc)</li>
<li>随后把第一个token重新放到input中, 让TeX再次read (read:Tabc)</li>
</ul>
<p>相当于一个\expandafter要吃两个参数,第一个参数先存着，第二个参数进行展开.  有了这个原理之后我们在看一看multiple \expandafter的情况. 一个具体的例子,参考自 Overleaf Understanding expandafter ,  网址如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">https://www.overleaf.com/learn/latex/Articles/How_does_%5Cexpandafter_work%3A_A_detailed_study_of_consecutive_%5Cexpandafter_commands<br></code></pre></td></tr></table></figure>
<p>定义 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>Y</mi></msub><mo>=</mo><msubsup><mtext>T</mtext><mi>Y</mi><mn>1</mn></msubsup><msubsup><mtext>T</mtext><mi>Y</mi><mn>2</mn></msubsup><mo>⋯</mo><msubsup><mtext>T</mtext><mi>Y</mi><mi>N</mi></msubsup></mrow><annotation encoding="application/x-tex">\text{T}_Y = \text{T}^1_{Y}\text{T}^2_{Y}\cdots\text{T}^N_{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1616em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> , 然后 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext>T</mtext><mi>Y</mi><mn>1</mn></msubsup><mo>=</mo><msubsup><mtext>T</mtext><mrow><mi>Y</mi><mn>1</mn></mrow><mi>A</mi></msubsup><msubsup><mtext>T</mtext><mrow><mi>Y</mi><mn>1</mn></mrow><mi>B</mi></msubsup><msubsup><mtext>T</mtext><mrow><mi>Y</mi><mn>1</mn></mrow><mi>C</mi></msubsup></mrow><annotation encoding="application/x-tex">\text{T}^1_{Y} = \text{T}^A_{Y1}\text{T}^B_{Y1}\text{T}^C_{Y1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1343em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1616em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>​，然后使用如下的命令:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>1</mn></msub><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>2</mn></msub><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>3</mn></msub><msub><mtext>T</mtext><mi>X</mi></msub><msub><mtext>T</mtext><mi>Y</mi></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_1\backslash\text{expandafter}_2\backslash\text{expandafter}_3\text{T}_X\text{T}_Y
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>下面我们来分析这个展开的过程:</p>
<ul>
<li>
<p>首先TeX在read过程中，首先读到第一个token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span>，然后这个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span> 把它后面的第一个 token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span> save，把它后面的第二个token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span> 展开(执行此token).</p>
<ul>
<li>现在我们进入到了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span>展开的子过程 (这其实是一个子递归)</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span> 会把它后面的第一个token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>X</mi></msub></mrow><annotation encoding="application/x-tex">\text{T}_X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> save, 然后把它后面的第二个 token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>Y</mi></msub></mrow><annotation encoding="application/x-tex">\text{T}_Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 展开</li>
<li>最后这个子过程得到的token list为: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>X</mi></msub><msubsup><mtext>T</mtext><mi>Y</mi><mn>1</mn></msubsup><msubsup><mtext>T</mtext><mi>Y</mi><mn>2</mn></msubsup><mo>⋯</mo><msubsup><mtext>T</mtext><mi>Y</mi><mi>N</mi></msubsup></mrow><annotation encoding="application/x-tex">\text{T}_X\text{T}^1_{Y}\text{T}^2_{Y}\cdots\text{T}^N_{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1616em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>​</li>
</ul>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span>子过程(子递归)结束，把前面 save 的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span> 重新 re-inserted 进 input . 所以现在的 token list 为: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>2</mn></msub><msub><mtext>T</mtext><mi>X</mi></msub><msubsup><mtext>T</mtext><mi>Y</mi><mn>1</mn></msubsup><msubsup><mtext>T</mtext><mi>Y</mi><mn>2</mn></msubsup><mo>⋯</mo><msubsup><mtext>T</mtext><mi>Y</mi><mi>N</mi></msubsup></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_2\text{T}_X\text{T}^1_{Y}\text{T}^2_{Y}\cdots\text{T}^N_{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1646em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>, TeX 继续处理这个 token list 的展开</p>
</li>
<li>
<p>对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">\</mi><msub><mtext>expandafter</mtext><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\backslash\text{expandafter}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">\</span><span class="mord"><span class="mord text"><span class="mord">expandafter</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span>, 其后的第一个 token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">\text{T}_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 被 save, 其后的第二个token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext>T</mtext><mi>Y</mi><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">\text{T}^1_Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1343em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 被展开.</p>
</li>
<li>
<p>token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext>T</mtext><mi>Y</mi><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">\text{T}_Y^1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1343em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 的展开结束，把前面 save 的token-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>X</mi></msub></mrow><annotation encoding="application/x-tex">\text{T}_X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 再次 re-inserted 进 input</p>
</li>
<li>
<p>这个过程结束得到的 token list 为: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>T</mtext><mi>X</mi></msub><msubsup><mtext>T</mtext><mrow><mi>Y</mi><mn>1</mn></mrow><mi>A</mi></msubsup><msubsup><mtext>T</mtext><mrow><mi>Y</mi><mn>1</mn></mrow><mi>B</mi></msubsup><msubsup><mtext>T</mtext><mrow><mi>Y</mi><mn>1</mn></mrow><mi>C</mi></msubsup><msubsup><mtext>T</mtext><mi>Y</mi><mn>2</mn></msubsup><mo>⋯</mo><msubsup><mtext>T</mtext><mi>Y</mi><mi>N</mi></msubsup></mrow><annotation encoding="application/x-tex">\text{T}_X\text{T}^A_{Y1}\text{T}^B_{Y1}\text{T}^C_{Y1}\text{T}^2_{Y}\cdots\text{T}^N_{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1616em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9146em;"><span style="top:-2.453em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p>这个 token list 便是最终的展开结果 ,  其实可以把最后的展开结果总结为 :</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>T</mtext><mi>X</mi></msub><mo stretchy="false">⟨</mo><mtext>expansion of the first token in </mtext><msub><mtext>T</mtext><mi>Y</mi></msub><mo stretchy="false">⟩</mo><mo stretchy="false">⟨</mo><mtext> remaining tokens in </mtext><msub><mtext>T</mtext><mi>Y</mi></msub><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\text{T}_X\langle\text{expansion of the first token in } \text{T}_Y\rangle \langle\text{ remaining tokens in }\text{T}_Y\rangle
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">⟨</span><span class="mord text"><span class="mord">expansion of the first token in </span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mopen">⟨</span><span class="mord text"><span class="mord"> remaining tokens in </span></span><span class="mord"><span class="mord text"><span class="mord">T</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span></span></span></span></span></p>
</li>
</ul>
<p>把上面抽象的分析实体化为一个具体的实例如下:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-comment">% T_X</span><br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\foo</span><span class="hljs-params">#1</span>&#123;<span class="hljs-keyword">\textbf</span>&#123;<span class="hljs-params">#1</span>&#125;&#125;<br><br><span class="hljs-comment">% T_Y</span><br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\abc</span>&#123;Hello&#125;, <span class="hljs-keyword">\def</span><span class="hljs-keyword">\xyz</span>&#123;, World&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\bar</span>&#123;<span class="hljs-keyword">\abc</span><span class="hljs-keyword">\xyz</span>&#125;<br><br><span class="hljs-comment">% example</span><br><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\foo</span><span class="hljs-keyword">\bar</span><br></code></pre></td></tr></table></figure>
<p>最终得到的结果就是: <strong>H</strong>ello, world</p>
<p>也就是只加粗了第一个字母 ‘H’, 可以对比如下命令的结果来理解:</p>
<ul>
<li>\foo\bar: <strong>Hello, World</strong></li>
<li>\expandafter\foo\bar: <strong>Hello</strong>, world</li>
</ul>
<p>这样也许你就能看出\expandafter到底有啥作用? 到底是怎么作用的 ?</p>
<blockquote>
<p>别忘了 \expandafter 命令本身就可以看作一个 token</p>
</blockquote>
<p>其实LaTeX2e中有一个比较好用的命令: <code>\@expandtwoargs</code>, 可以在命令把这两个参数吃进去时，提前展开这两个参数</p>
<blockquote>
<p>突然感觉这个\expandafter 应该改名为\expandfirst了. 但是如果从整个命令的角度来看，就是 \uppercase operation expand after macro \cmda: means that \cmda will expand first.</p>
</blockquote>
<h4 id="read-expand-CS">read expand CS</h4>
<p>现在分享一个怎么读懂别人<code>\expanafter</code> 代码的方法，这个案例是本博客后续会用到的一个回答，代码如下:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\protected</span><span class="hljs-keyword">\def</span><span class="hljs-keyword">\pempty</span>&#123;&#125;<br><br><span class="hljs-keyword">\edef</span><span class="hljs-keyword">\withedef</span>&#123;x<span class="hljs-keyword">\pempty</span> x&#125;<br><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\def</span><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\withexpandafter</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandafter</span> x<span class="hljs-keyword">\pempty</span> x&#125;<br><br><span class="hljs-keyword">\tt</span><br><span class="hljs-keyword">\meaning</span><span class="hljs-keyword">\pempty</span>.<br><br><span class="hljs-keyword">\meaning</span><span class="hljs-keyword">\withedef</span>.<br><br><span class="hljs-keyword">\meaning</span><span class="hljs-keyword">\withexpandafter</span>.<br></code></pre></td></tr></table></figure>
<p>我们重点分析那一长串的 \expandafter, 这里先给出我的一个分析方法:</p>
<ul>
<li>
<p>从左往右，依次划掉  “1个  \expandafter + 1个 token”</p>
</li>
<li>
<p>最后从后往前分析，把之前划掉的 token 一步一步的加回来(如果划掉的token是 \expanafter 也要加回来)</p>
</li>
</ul>
<p>所以你可以按照如下过程分析:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-comment">% 划掉 token:\def</span><br><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\def</span><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\withexpandafter</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandafter</span> x<span class="hljs-keyword">\pempty</span> x&#125;<br><br><span class="hljs-comment">% 划掉 token:\withexpandafter</span><br><span class="hljs-keyword">\expandafter</span><span class="hljs-keyword">\withexpandafter</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandafter</span> x<span class="hljs-keyword">\pempty</span> x&#125;<br><br><span class="hljs-comment">% 划掉 token:&#123;</span><br><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandafter</span> x<span class="hljs-keyword">\pempty</span> x&#125;<br><br><span class="hljs-comment">% 划掉 token:x</span><br><span class="hljs-keyword">\expandafter</span> x<span class="hljs-keyword">\pempty</span> x&#125;<br><br><span class="hljs-comment">% 最后expand \pempty</span><br>x&#125;<br></code></pre></td></tr></table></figure>
<p>因为最后的一个  \pempty 虽然被 \protected 保护了, 但是使用 \expandafter 仍然可以把它给展开. 于是我们一步一步的加回来被划掉的 token，过程如下:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs latex">x&#125;<br><br>xx&#125;<br><br>&#123;xx&#125;<br><br><span class="hljs-keyword">\withexpandafter</span>&#123;xx&#125;<br><br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\withexpandafter</span>&#123;xx&#125;<br></code></pre></td></tr></table></figure>
<p>所以最后得到的结果就是:</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crystal">\<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">macro</span>:<span class="hljs-title">-</span></span>&gt;.<br><span class="hljs-function"><span class="hljs-keyword">macro</span>:<span class="hljs-title">-</span></span>&gt;x\pempty x.<br><span class="hljs-function"><span class="hljs-keyword">macro</span>:<span class="hljs-title">-</span></span>&gt;xx.<br></code></pre></td></tr></table></figure>
<p>第一个命令 \withedef 中的  \pempty 由于被 \protected 了，所以不能被 \edef 给展开.</p>
<blockquote>
<p>因为 \pempty  是一个macro，所以它和后面  ‘x’ 之间的空格会被吃掉</p>
</blockquote>
<h4 id="write-expand-CS-I">write expand CS-I</h4>
<p>我们当然不能局限于仅仅只是看懂expand，很多时候其实我们需要的是自己去写这个expand，知道了原理之后其实并不复杂. 就以前面的那个</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span>&#123;abc<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>为例. 为了一步一步的引导新手怎么写这个<code>\expandafter</code>，我们先从一个简单的例子开始. 下面这个代码片段是错误的:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\expandafter</span>&#123;a<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>怎么把这个展开写正确? 在此之前，让我先给出我总结这个规律：</p>
<div class="note note-success">
            <p>在一个要被前一个<code>\expandafter</code>展开的 token 前添加一个<code>\expandafter</code>，可以让这个 token 后面的宏提前展开</p>
          </div>
<p>在这里的情况就是：上述的expand会去展开字母 ‘a’, 但是我们想要的是去展开 ‘a’ 后面的 macro <code>\cmda</code>, 那么就需要让这个<code>\expandafter</code>的展开对象后移1个 token. 所以只需要在这个 ‘a’ 的前面添加一个 <code>\expandafter</code> 即可，所以正确的代码为:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandafter</span> a<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>好，现在增大难度，有两个letters “ab”, 如果直接像下面这样写:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\expandafter</span>&#123;b<span class="hljs-keyword">\expandafter</span> a<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>那么<code>\uppercese</code>后面的第一个 <code>\expanafter</code> 回去展开 ‘b’, 和前面类似，我们需要展开的对象后移一个 token; 所以直接在 ‘b’ 的前面加上一个 <code>\expandafter</code>, 正确的代码如下:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandable</span> b<span class="hljs-keyword">\expandafter</span> a<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<p>所以对于三个letters下的正确展开代码就是:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\expandafter</span>&#123;<span class="hljs-keyword">\expandafter</span> c<span class="hljs-keyword">\expandafter</span> b<span class="hljs-keyword">\expandafter</span> a<span class="hljs-keyword">\cmda</span>&#125;<br></code></pre></td></tr></table></figure>
<div class="note note-success">
            <p>所以最后看来：命令<code>\expandafter</code>展开 token 的过程就是以 token 为单位，从左至右，跳着展开的.</p>
          </div>
<h4 id="write-expand-CS-II">write expand CS-II</h4>
<p>本节内容部分参考自问题: <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/26916597">多个\expandafter的展开过程是怎样的</a></p>
<p><strong>引入</strong><br>
首先介绍三个宏的逆序展开，并且以此来总结一个规律用于之后的代码书写. 为了代码的书写方便，进行一定的记号规定</p>
<blockquote>
<ul>
<li>\let\ep\expanafter</li>
<li><code>&lt;A&gt;</code> 表示宏 <code>\A</code> 的展开内容</li>
</ul>
</blockquote>
<p>下面即为代码展开过程的详细说明:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\let</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\expandafter</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\C</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\C</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\C</span><br>&lt;C&gt;<br><br>&lt;C&gt;<br><span class="hljs-keyword">\B</span>&lt;C&gt;<br><span class="hljs-keyword">\A</span><span class="hljs-keyword">\B</span>&lt;C&gt;<br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\B</span>&lt;C&gt;<br><span class="hljs-keyword">\A</span>&lt;B&gt;&lt;C&gt;<br></code></pre></td></tr></table></figure>
<p>所以从上面可以发现一个总结出如下的展开规律:</p>
<ul>
<li>位于<strong>偶数</strong>位置的 token 均被 save 了，位于<strong>奇数</strong>位置的则被展开了(跳着生效，跳着展开)</li>
<li>被展开的 <code>\ep</code> 直接扔掉，被展开的 <code>宏内容</code> 就保留下来</li>
</ul>
<p><strong>逆向分析</strong><br>
下面就运用上面总结的规律构造四个宏逆序展开的代码:我们要构造四个宏的逆序展开命令(*)，那么四个宏对应的命令展开一次后就会得下面的这个序列(因为第四个宏最先被展开)：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\C</span>&lt;D&gt;      (**)<br></code></pre></td></tr></table></figure>
<blockquote>
<p>后续为了讲解的便利，我们把 (*) 看作公式编号</p>
</blockquote>
<p>又因为(*)是跳着展开的，所以上述序列-(**)就位于原序列(*)的偶数位置. 为什么没有出现第四个宏? 因为第四个宏 <code>\D</code> 已经被展开为 <code>&lt;D&gt;</code> 了，而(**)中仅包含被 save 的 token. 于是添加等数量的 <code>\exp</code> 即可确定原(*)序列为：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span><span class="hljs-keyword">\D</span>   (*)<br></code></pre></td></tr></table></figure>
<p>其中高亮部分就表示(**)中的元素, 从而格式化后原逆序展开四个宏的代码为：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span><br><span class="hljs-keyword">\D</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>后续会说明为什么这样写代码，部分情况你可能需要在每一行的末尾加上 % 注释掉多余的空格.</p>
</blockquote>
<p><strong>统计规律</strong><br>
下面我们总结<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>个宏逆序展开的规律,得出这种类型宏的写法：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-comment">% n = 2</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\B</span><br><br><span class="hljs-comment">% n=3</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><br><span class="hljs-keyword">\C</span><br><br><span class="hljs-comment">% n=4</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span><br><span class="hljs-keyword">\D</span><br><br><span class="hljs-comment">% n=5</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\D</span><br><span class="hljs-keyword">\E</span><br></code></pre></td></tr></table></figure>
<p>下面来统计每一行的 token 数目,下面不同 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 值下统计的 token 数：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-comment">% n=2</span><br>1+1+<br>1<br><br><span class="hljs-comment">% n=3</span><br>2+2+<br>1+1+<br>1<br><br><span class="hljs-comment">% n=4</span><br>4+4+<br>2+2+<br>1+1+<br>1<br><br><span class="hljs-comment">% n=5</span><br>8+8+<br>4+4+<br>2+2+<br>1+1+<br>1<br><br><span class="hljs-comment">% n=6</span><br>16+16+<br>8+8+<br>4+4+<br>2+2+<br>1+1+<br>1<br></code></pre></td></tr></table></figure>
<p>所以逆序展开 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个宏总共所需的 tokens 数目 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 为:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>N</mi><mo>=</mo><mn>1</mn><mo>+</mo><mn>2</mn><mo>+</mo><mo>⋯</mo><mo>+</mo><msup><mn>2</mn><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mn>2</mn><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">N = 1+2+\cdots+ 2^{n-1} = \sum_{i=1}^n 2^{n-1} \tag {1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>然后统计每一行的 <code>\ep</code> 个数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">N_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 可以发现, 从下到上每一层 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> 的 <code>\ep</code> 数量为:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>N</mi><mi>i</mi></msub><mo>=</mo><msup><mn>2</mn><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>1</mn></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">    N_i = 2^{i-1}-1 \tag{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.958em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span><span class="tag"><span class="strut" style="height:1.1247em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>所以今后写这种宏就可以按照这种规律来写了，但是部分的问题可能还的具体分析吗，不可能情况下都是最简洁的.</p>
<p><strong>跳跃展开</strong><br>
之前都是反正，正向顺序一词展开的, 那么如果是我要求展开顺序为:<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>→</mo><mi>C</mi><mo>→</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">B\rightarrow C\rightarrow A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 呢? 你肯定不能把原始命令 (*) 写成下面这样：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span><br><span class="hljs-keyword">\B</span><br></code></pre></td></tr></table></figure>
<p>写成这样都不一定能运行，毕竟这些 token 的顺序不一定能够交换(也就是输入的格式必须为:<code>\A\B\C</code>). 那么怎么写? 我们采用逆向分析的方法, 一步一步的反推展开前的控制序列.</p>
<p>先不考虑 <code>\A</code> 命令的展开，因为是先展开 <code>\B</code>, 然后再展开 <code>\C</code>, 所以原控制序列 (*) 展开一个宏后得到的结果 (**) 肯定是:<code>\A\ep&lt;B&gt;\C</code>，再添加对应数量的 <code>\ep</code> 后可以得到展开前的原控制序列 (*) 为：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\C</span>            (*)<br></code></pre></td></tr></table></figure>
<p>但是现在还有一个问题:如果 TeX 再去读取 <code>\A\ep&lt;B&gt;\C</code> 这个结果，那么它会先去展开 <code>\A</code>, 所以我们的想办法让 <code>\A</code> 后面再展开。于是就必须在 <code>\A</code> 前要加上 <code>\ep</code>. 所以考虑到 <code>\A</code> 的展开顺序，那么展开后的命令 (**) 为：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span>&lt;B&gt;<span class="hljs-keyword">\C</span>           (**)<br></code></pre></td></tr></table></figure>
<p>具体到每一个宏，从左到右其展开前应为：</p>
<ul>
<li><code>\ep\ep</code>：因第一个\ep保留，故它是偶数</li>
<li><code>\ep\A</code>： 保留</li>
<li><code>\ep\ep</code>：保留</li>
<li><code>\B\ep</code>： 因被展开，故奇数，后面加 <code>\ep</code></li>
<li><code>\ep\C</code>： 保留</li>
</ul>
<p>所以最终的原始控制序列 (*) 为：</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span>     (*)<br><br><span class="hljs-comment">% format code</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span> <br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\C</span><br></code></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<ul>
<li>其中那个 <code>\ep</code> 的作用是为了占位，为了防止这个占位 <code>\ep</code> 对其他内容产生影响，可以考虑在 <code>\C</code> 后加上 <code>\empty</code> 等类似的宏.</li>
<li>如果不添加这个占位，那么最后的 <code>\C</code> 其实也可以保留下来(只要对应的宏 <code>\C</code> 能被保留，也就是保证其在原序列中位于偶数位置)，代码如下：  <figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-keyword">\C</span>       (*)<br><br><span class="hljs-comment">% format code</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span> <br><span class="hljs-keyword">\C</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>检验代码是否正确</strong><br>
为了检验我们这个代码是否正确，我写了一个 mwe 用于测试，如下:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\documentclass</span>&#123;article&#125;<br><span class="hljs-keyword">\let</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\expandafter</span><br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\A</span><span class="hljs-params">#1</span>&#123;<span class="hljs-keyword">\uppercase</span>&#123;<span class="hljs-params">#1</span>&#125;&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\B</span><span class="hljs-params">#1</span>&#123;&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\c</span>&#123;Hello&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\C</span>&#123;<span class="hljs-keyword">\c</span>&#125;<br><br><span class="hljs-keyword">\begin</span>&#123;document&#125;<br><span class="hljs-keyword">\Huge</span><br><span class="hljs-keyword">\section</span>&#123;expand times/depth&#125;<br><span class="hljs-comment">% C → A</span><br><span class="hljs-comment">% \expanafter only expand a macro once (or depth=1)</span><br><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span>&#123;<span class="hljs-keyword">\C</span>&#125;<br><span class="hljs-keyword">\uppercase</span><span class="hljs-keyword">\ep</span>&#123;<span class="hljs-keyword">\c</span>&#125;<br><br><br><span class="hljs-keyword">\section</span>&#123;Expand order&#125;<br><span class="hljs-comment">% C → B → A</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-comment">%</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-comment">%</span><br><span class="hljs-keyword">\c</span><br><br><span class="hljs-comment">% B → C → A</span><br><span class="hljs-comment">% 由于 B先展开，所以就把\C整个给吃了，</span><br><span class="hljs-comment">% 从而导致\A没有接受到参数，所以报错</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\A</span><span class="hljs-comment">%</span><br><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\ep</span><span class="hljs-keyword">\B</span><span class="hljs-comment">%</span><br><span class="hljs-keyword">\c</span><br><span class="hljs-keyword">\end</span>&#123;document&#125;<br></code></pre></td></tr></table></figure>
<p>上述构造的三个宏 <code>\A, \B, \C</code> 的作用和效果见源代码注释. 这里的重点是检测宏的展开顺序，如果是 <code>\B</code> 最先展开，那么它必然会把后面的 <code>\C</code> 这个 token 给吃掉，但是 <code>\B</code> 什么都没有留下，也就导致了后续 <code>\A</code> 展开的过程中没有参数的传入，导致报错. 但是如果是 <code>\C</code> 先展开，那么 <code>\B</code> 就只会吃掉对一个的 <code>token</code> ‘H’, 后续的 <code>\A</code> 会把剩下的 <code>ello</code> 的第一个 token 给 uppercase 了.</p>
<p>最后的运行结果如下:<br>
<img src="/img/expansion_in_tex/output.png" srcset="/img/loading.gif" lazyload alt="output"></p>
<p><img src="/img/expansion_in_tex/error_log.png" srcset="/img/loading.gif" lazyload alt="ouput log"></p>
<p><strong>总结</strong></p>
<ul>
<li>其实就是从结果去一步一步倒推上一步，在这个过程中考虑一下奇偶 <code>token</code>. 毕竟奇偶涉及到这个 <code>token</code> 是保留还是展开.</li>
<li>如果多个 <code>\ep</code> 分布的较为稀疏，那么它们可能就是多个组，并不是一个组前面的命令 <code>\uppercase\ep&#123;\cmda&#125;</code> 和这里的 <code>\ep</code> 命令也是相同的，只不过上述的 <code>&#123;</code> 就是这里的 <code>\A</code>, <code>\cmda</code> 就是上述的 <code>\B</code>.</li>
</ul>
<blockquote>
<p>突然发现之前也没有遇到这种多个宏展开的问题了</p>
</blockquote>
<h3 id="noexpand-and-protect">noexpand and protect</h3>
<p>如果你不想提前展开某些 macro 呢? 这个特性在 TeX 中其实是随处可见的，比如常用的 \thepage 命令，如果我们设置这个 macro 为具体的数值肯定是不行的，这个 \thepage 的数值得随着不同的页面变化. 可以认为这个 \thepage 里面就有一些 macro 没有被完全展开，它们只有在打印具体的页数的时候才会被完全展开.</p>
<blockquote>
<p>这个机制应该就叫做 lazy evaluation 吧, 类似于 mma 中的延迟赋值 f[x_] := x;</p>
</blockquote>
<p>再来一个简单的例子:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\def</span><span class="hljs-keyword">\cmda</span>&#123;a&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\cmdb</span>&#123;<span class="hljs-keyword">\cmda</span>&#125;<br><br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\cmda</span>&#123;A&#125;<br></code></pre></td></tr></table></figure>
<p>上述定义的\cmdb就是没有被展开的例子, 当我 \cmda 重定义为&quot;A&quot;后，对应命令 \cmdb 也会被重定义为 “A”.</p>
<p>这里可以介绍几个基本的命令:</p>
<ul>
<li>
<p>\noexpand: prevents doing an expansion of the next token (only <strong>one</strong> token).</p>
</li>
<li>
<p>\unexpanded: e-TeX includes an additional primitive \unexpanded, which will prevent expansion of <strong>multiple</strong> tokens.</p>
</li>
</ul>
<p>既然都说到这里的，就必须要提到这一系列命令了: \def, \gdef, \edef, \xdef. 以及对应的 e-TeX 拓展的命令\protected 了. 这里必须抄一段 <a target="_blank" rel="noopener" href="https://tex.stackexchange.com/a/12148/294585">TEX SE 的回答</a> :</p>
<p>The prefix <code>\protected</code>  can be used before <code>\def</code> and friends to define a protected, i.e. “robust” macro which doesn’t expand inside an <code>\edef</code> context (like in <code>\write</code>). However, <code>\expandafter</code> does expand such a macro.</p>
<blockquote>
<ul>
<li>这个所谓的  robust 在你们刚入门的时候应该也不理解吧</li>
<li>所谓的 \xdef 可以看成是 \gdef 和 \edef 的结合体</li>
</ul>
</blockquote>
<h3 id="further-reading">further reading</h3>
<p>更多的详细教程可以参见: <a target="_blank" rel="noopener" href="https://www.overleaf.com/learn/latex/Articles">Overleaf Articles</a>, 里面有挺多不错的东西.</p>
<h2 id="LaTeX-3">LaTeX 3</h2>
<h3 id="introduction">introduction</h3>
<p>在LaTeX 3中是可以很方便的操控宏展开的，可以有如下的途径:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\exp_not:N</span> <br><br><span class="hljs-keyword">\exp_args:N</span>⟨variant⟩ <br><br><span class="hljs-keyword">\exp_args_generate:n</span><br><br><span class="hljs-keyword">\cs_generate_variation:Nn</span> <br><br><span class="hljs-keyword">\prg_generate_conditional_variant:Nnn</span> <br></code></pre></td></tr></table></figure>
<p>这5个命令用的好，就不用担心绝大部分的展开问题了. 第一个 <code>\exp_not:N</code> 可以控制一个宏不被 <code>e</code>-type 或者是 <code>x</code>-type 展开.</p>
<h3 id="expandable-variable">expandable variable</h3>
<p>部分用户也许经常在 interface 3 中看到诸如下面这样的 TeXhackers note, 下面这个例子是 <code>\tl_tail:N</code> 的 note:</p>
<blockquote>
<p>The result is returned within \exp_not:n, which means that the token list does not expand further when appearing in an e-type or x-type argument expansion</p>
</blockquote>
<p>我们下面就写一个具体的例子来说明这个 note 到底说了怎样一回事:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpa_tl</span> &#123;a<span class="hljs-keyword">\l_tmpb_tl</span>&#125;<br><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#123;b&#125;<br><span class="hljs-keyword">\tl_set:Nx</span> <span class="hljs-keyword">\l_tmpd_tl</span> &#123;<span class="hljs-keyword">\l_tmpb_tl</span> <span class="hljs-keyword">\tl_tail:N</span><span class="hljs-keyword">\l_tmpa_tl</span>&#125;<br><span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpd_tl</span><br></code></pre></td></tr></table></figure>
<p>这段代码的结果是: <code>macro:-&gt;b\l_tmpb_tl</code>; 因为 <code>\tl_tail:N</code> 的结果是 <code>\l_tmpa_tl</code>, 而这个宏是 within <code>\exp_not:n</code> 的，也就是说:上面 <code>\tl_set:Nx</code> 这一行其实等价于:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\tl_set:Nx</span> <span class="hljs-keyword">\l_tmpd_tl</span> &#123;<span class="hljs-keyword">\l_tmpb_tl</span> <span class="hljs-keyword">\exp_not:n</span> &#123;<span class="hljs-keyword">\l_tmpb_tl</span>&#125;&#125;<br></code></pre></td></tr></table></figure>
<p>这样我们的 <code>\l_tmpa_tl</code> 中的第二个 token 自然就是 <code>\l_tmpb_tl</code> 的原始定义了，而不是 <code>b</code>.</p>
<p>被 <code>\protected</code> 的宏也不会被 <code>e</code>-type 和 <code>x</code>-type 展开; 故而 <code>xparse</code> 提供的 <code>\NewDocumentCommand</code> 等一系列的命令定义的宏和被 <code>\noexpand</code> 修饰定义的宏无法被正常展开.</p>
<p>注意区分 <code>\protect</code> 与 <code>\protected</code>; 这两者是没有关系的, <code>\protected</code> 的作用机制和 <code>\long</code> 的类似。还可以这样理解: 前者是 LaTeX 内部提供的为了弥补没有 <code>\protected</code> 宏的一个 trick，后者是 eTeX 提供的; 对于 <code>\protect</code>, 它会在 normal context 中，它会被展开为 <code>\relax</code>; 在部分特殊的 context 中会被定义为 <code>\noexpand\protect\noexpand</code>, 在部分的 context 中也会被定义为 <code>\noexpand</code>.</p>
<p>详细信息,可以参见:<a target="_blank" rel="noopener" href="https://tex.stackexchange.com/a/4747/294585">why do we need \protect</a> (可以认为这个参考样例中的 <code>\protect</code> 起了一个传递作用，为了把 <code>\noexpand</code> 传递到第二个过程中；个人觉得也可以在第一步传递一个 <code>\foobar</code> 过去，得到 <code>\foobar\foo</code>, 然后在把行命令写到 toc 文件之前，把 <code>\foobar</code> 定义为 <code>\noexpand</code> 也行。但是两次都用 <code>\protect</code> 我觉得更好，更加的统一.)</p>
<p>下面就是一个示例:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpa_tl</span> &#123;a&#125;<br><span class="hljs-keyword">\protected</span><span class="hljs-keyword">\def</span><span class="hljs-keyword">\cmda</span>&#123;CMD-A&#125;<br><span class="hljs-keyword">\newcommand</span><span class="hljs-keyword">\cmdb</span>&#123;CMD-B&#125;<br><span class="hljs-keyword">\NewDocumentCommand</span><span class="hljs-keyword">\cmdc</span>&#123;&#125;&#123;CMD-C&#125;<br><span class="hljs-keyword">\tl_set:Nx</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#123;<span class="hljs-keyword">\l_tmpa_tl</span> <span class="hljs-keyword">\cmda</span> <span class="hljs-keyword">\noexpand</span><span class="hljs-keyword">\cmdb</span> <span class="hljs-keyword">\cmdc</span>&#125;<br><span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpb_tl</span><span class="hljs-keyword">\par</span><br></code></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex">macro:-&gt;a<span class="hljs-keyword">\cmda</span> <span class="hljs-keyword">\cmdb</span> <span class="hljs-keyword">\cmdc</span><br></code></pre></td></tr></table></figure>
<p>如果把上述的 <code>\noexpand</code> 去掉，那么 <code>\cmdb</code> 就会被展开为 <code>CMD-B</code>. 可以参见前一节: “noexpand and protect”. 然后再来说一下这个 robust,见示例:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpa_tl</span> &#123;a&#125;<br><span class="hljs-keyword">\DeclareRobustCommand</span><span class="hljs-keyword">\robcmd</span>&#123;ROBUST-CMD&#125;<br><span class="hljs-keyword">\tl_set:Nx</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#123;<span class="hljs-keyword">\l_tmpa_tl</span> <span class="hljs-keyword">\robcmd</span>&#125;<br><span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpb_tl</span><br></code></pre></td></tr></table></figure>
<p>对应的输出为:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex">macro:-&gt;a<span class="hljs-keyword">\protect</span> ROBUST-CMD<br></code></pre></td></tr></table></figure>
<p>我们也可以用 <code>\MakeRobust</code>这个命令来让一个已经存在的 fragile command 编程 robust command.</p>
<h3 id="expandable-function">expandable function</h3>
<p>把 LaTeX 中的宏划分为 Variable 和 Function 是不太准确的，但为说明 <code>xparse</code> 宏包中 <code>\NewExpandableDocumentCommand</code> 等系列命令存在的意义，我这里就认为的进行了划分，并且 LaTeX 3 中也是区分了变量和函数的.</p>
<blockquote>
<p>大部分的用户如果弄不清一个函数是不是 expandable 的，那么建议你一律使用 <code>\newcommand</code>.</p>
</blockquote>
<p>一个函数是 expandable 的，就意味着你可以直接把这个函数当成一个值（前提是你的函数要有返回值,并且处于一个expand 的 context 中）直接在一个表达式中参与运算, 而不用再新建一个变量来存储这个函数返回的值，然后再用这个新的变量进行表达式的操作.</p>
<p>一个普通示例:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\newcommand</span>&#123;<span class="hljs-keyword">\double</span>&#125;[1]&#123;<span class="hljs-params">#1</span>*2&#125;<br><span class="hljs-keyword">\NewDocumentCommand</span>&#123;<span class="hljs-keyword">\triple</span>&#125;&#123;m&#125;&#123;<span class="hljs-params">#1</span>*3&#125;<br><span class="hljs-keyword">\NewExpandableDocumentCommand</span>&#123;<span class="hljs-keyword">\quart</span>&#125;&#123;m&#125;&#123;<span class="hljs-params">#1</span>*4&#125;<br><span class="hljs-keyword">\edef</span><span class="hljs-keyword">\Expandcmd</span>&#123;<span class="hljs-keyword">\double</span>&#123;2&#125;&#125;<br><span class="hljs-keyword">\edef</span><span class="hljs-keyword">\nonExpandcmd</span>&#123;<span class="hljs-keyword">\triple</span>&#123;3&#125;&#125;<br><span class="hljs-keyword">\edef</span><span class="hljs-keyword">\NewExpandcmd</span>&#123;<span class="hljs-keyword">\quart</span>&#123;4&#125;&#125;<br><span class="hljs-keyword">\meaning</span><span class="hljs-keyword">\Expandcmd</span><span class="hljs-keyword">\par</span><br><span class="hljs-keyword">\meaning</span><span class="hljs-keyword">\nonExpandcmd</span><span class="hljs-keyword">\par</span><br><span class="hljs-keyword">\meaning</span><span class="hljs-keyword">\NewExpandcmd</span><span class="hljs-keyword">\par</span><br></code></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs latex">macro:-&gt;2*2<br>macro:-&gt;<span class="hljs-keyword">\triple</span> &#123;3&#125;<br>macro:-&gt;4*4<br></code></pre></td></tr></table></figure>
<p>从 TeXLive 2019 开始, pdfTeX, XeTeX, LuaTeX 中提供了 <code>\expanded</code> 这个primitive (最开始仅在 LuaTeX 中可用, 更多的信息可以参见: <a target="_blank" rel="noopener" href="https://tex.stackexchange.com/q/489063/294585">Does \expanded replace the \romannumeral trick for expansion?</a>), 这个 primitive 和 LaTeX 3 中的 <code>e</code>-type 是密切相关的，可以说这就是后者的基础.并且也是 <code>e</code>-type 和 <code>x</code>-type 的一个重要区别(LaTeX3 中 <code>\tex_expanded:D</code> 的原定义即为 <code>\expanded</code>).</p>
<blockquote>
<p><code>\expanded</code> gives a nice mix of both <code>\edef</code> and <code>\romannumeral</code>, allowing us to get the full expansion of a token list while being itself expndable</p>
</blockquote>
<p>在介绍之前，先复制粘贴几个 interface 3 中的 remark:</p>
<blockquote>
<ul>
<li><strong>Fully expandable functions</strong>: Some functions are fully expandable, which allows them to be used within an x-type or e-type argument (in plain TEX terms, inside an \edef or \expanded), as well as within an f-type argument. These fully expandable functions are indicated in the documentation by a <strong>star(★)</strong></li>
<li><strong>Restricted expandable functions</strong>: A few functions are fully expandable but cannot be fully expanded within an f-type argument. In this case a <strong>hollow star(☆)</strong> is used to indicate this</li>
</ul>
</blockquote>
<p>好了，接下来我们看看 <code>\expanded</code> 的使用方法:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\def</span><span class="hljs-keyword">\aaa</span>&#123;aaa&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\Oldupercase</span><span class="hljs-params">#1</span>&#123;<br>  <span class="hljs-keyword">\uppercase</span>&#123;<span class="hljs-params">#1</span>&#125;<br>&#125;<br><span class="hljs-keyword">\def</span><span class="hljs-keyword">\Newupercase</span><span class="hljs-params">#1</span>&#123;<br>  <span class="hljs-keyword">\expanded</span>&#123;<span class="hljs-keyword">\uppercase</span>&#123;<span class="hljs-params">#1</span>&#125;&#125;<br>&#125;<br><span class="hljs-keyword">\Oldupercase</span>&#123;<span class="hljs-keyword">\aaa</span>&#125;<span class="hljs-keyword">\Newupercase</span>&#123;<span class="hljs-keyword">\aaa</span>&#125;<br></code></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex">aaa AAA<br></code></pre></td></tr></table></figure>
<h3 id="argument-specifier-Ref">argument specifier Ref</h3>
<p>下面讲解一些关于argument specifier的东西，毕竟这个东西你是必要要学会的，如果你要使用 LaTeX 3 中的上面两个命令的话. Every function must include an argument specifier. For functions which take no arguments, this will be blank and the function name will end <code>:</code>.</p>
<ul>
<li><strong>N</strong> and <strong>n</strong>: means “no manipulation”, pass the argument through exactly as given</li>
<li><strong>c</strong>: means “csname”, argument be turned into a csname. like <code>\csname mycmd \csname</code>.</li>
<li><strong>V</strong> and <strong>v</strong>: means “value of variable”, get the content of a variable: <code>V</code> argument will be a single token (similar to <code>N</code>), using <code>v</code> a csname is constructed first, and then the value is recovered. So<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-comment">% 两个等价的命令</span><br><span class="hljs-keyword">\foo</span>:V <span class="hljs-keyword">\MyVariable</span><br><span class="hljs-keyword">\foo</span>:v &#123;MyVariable&#125;<br></code></pre></td></tr></table></figure>
You can only define a base function argument is <code>n</code> instead of <code>v</code>, <code>x</code>, <code>e</code>, <code>o</code> etc. Then generiant the variant(only <code>n</code> can be variant).</li>
<li><strong>o</strong>: means “expansion once” (Is it equvilant to expand only the first macro once?), while that <code>V</code>,<code>v</code> are prefered.</li>
<li><strong>x</strong>: means “exhaustive expansion”, fully expand every macro(until only unexpandable ones remain). Functions which feature an <code>x</code>-type argument are not expandable.</li>
<li><strong>e</strong>: means “expandable functions”, The <code>e</code> specifier is in many respects identical to <code>x</code>, Functions which feature an <code>e</code>-type argument may be expandable. Besides, Parameter character (like <code>#1</code>, <code>#2</code>, …) in the argument need not be doubled (when in nest loop).</li>
<li><strong>f</strong>: means “first token expansion”. The <code>f</code> specifier stands for full expansion, and in contrast to <code>x</code>, this type stops at the first non-expandable token(<code>&lt;space&gt;</code> is gobbled) (reading the argument from left to right) without trying to expand it.</li>
<li><strong>T/F</strong>: Ture/False in logic test.</li>
<li><strong>p</strong>: means TeX “traditional parameters”, like  <figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\cs_set:Npn</span> <span class="hljs-keyword">\foo</span>:n <span class="hljs-params">#1</span>&#123;<span class="hljs-keyword">\textbf</span>&#123;<span class="hljs-params">#1</span>&#125;&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><strong>w</strong>: means “weird arguments”, This covers everything else, but mainly applies to delimited values</li>
</ul>
<p>再看一个来自 interface 3.pdf 和 expl3.pdf 中的简短总结:</p>
<ul>
<li><code>N</code> is used for single-token arguments while <code>c</code> constructs a control sequence from its name and passes it to a parent function as an <code>N</code>-type argument.</li>
<li>Many argument types extract or expand some tokens and provide it as an <code>n</code>-type argument, namely a braced multipe-token argument: <code>V</code> extracts the value of a variable, <code>v</code> extracts the value from the name of a variable, <code>n</code> uses the argument as it is, <code>o</code> expands once, <code>f</code> expands fully the front of the token list, <code>e</code> and <code>x</code> expand<br>
fully all tokens (This type is not <strong>nestable</strong>, thus <code>x</code>-type does not work in <code>e</code> or <code>x</code>-type, while <code>e</code>-type does work in <code>x</code> and <code>e</code>-type; And it can only be used to create <strong>non-expandable</strong> functions).</li>
<li>A few odd argument types remain: <code>T</code> and <code>F</code> for conditional processing, otherwise identical to <code>n</code>-type arguments, <code>p</code> for the parameter text in definitions, <code>w</code> for arguments with a specific syntax, and <code>D</code> to denote primitives that should not be used directly.</li>
</ul>
<blockquote>
<p>In almost all cases, <code>e</code>-type should be preferred, <code>x</code>-type retained largely for historical reasons, and should where possible be replaced by the <code>e</code>-type equivalent. — From <code>expl3.pdf</code></p>
</blockquote>
<h3 id="expand-or-excute">expand or excute</h3>
<p>关于 expand 和 excute 的区别? 目前我觉得 expand 就是替换，而 excute 就是“吃(前面被展开的)参数”，这个参数可以是一个控制序列，也可以是一个 token list. 比如下面这个case:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\def</span><span class="hljs-keyword">\foo</span><span class="hljs-params">#1</span>&#123;<span class="hljs-params">#1</span>&#125;<br></code></pre></td></tr></table></figure>
<p>如果在 expand only 的 context 中，<code>\def</code> 并不会把 <code>\foo</code> 这个token 吃进去，返回会留在这个；然后再继续去展开这个 <code>\foo</code> 如果 <code>\foo</code> 没有定义，那么必然报错.</p>
<p>那么哪些 context 是 expand only 的呢？常见的有:</p>
<ul>
<li><code>\edef</code></li>
<li><code>\write</code></li>
<li><code>\csname \endcsname</code></li>
<li>我们前面讲到的 <code>\expandafter</code></li>
<li><code>f</code> and <code>e</code> specifier in LaTeX 3.</li>
</ul>
<p>所以这个时候我们也许就需要另外一个 data type 了: <code>Expandable flags</code>. 看看文档中对这个 data type 的定义:</p>
<blockquote>
<p>Flags are the only data-type that can be modified in expansion-only contexts.</p>
</blockquote>
<p>但是我们也不用太过担心这个 expand only, 一般都是 kernel 或者是 toc 之类的东西才会涉及到. 普通情况下用 int, 或者是<br>
boolean 之类的就行了.</p>
<h3 id="How-to-generate-variants">How to generate variants</h3>
<p>First of all, only <code>n</code> and <code>N</code> arguments can be changed to other types. The only allowed changes are:</p>
<ul>
<li><code>c</code> variant of an <code>N</code> parent;</li>
<li><code>o</code>, <code>V</code>, <code>v</code>, <code>f</code>, <code>e</code>, or <code>x</code> variant of an n parent;</li>
<li><code>N</code>, <code>n</code>, <code>T</code>, <code>F</code>, or <code>p</code> <strong>argument unchanged</strong>, useful in command <code>\cs_generate_variation:Nn</code>, see <a target="_blank" rel="noopener" href="https://tex.stackexchange.com/q/404860/294585">LaTeX3 variants with TF arguments</a>.</li>
</ul>
<h3 id="f-type">f-type</h3>
<p>f-type 这一个argument specifier 可能比较奇怪，但是可以参见如下的示例:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-comment">% &#x27;f&#x27;-type expansion</span><br><span class="hljs-keyword">\tl_new:N</span> <span class="hljs-keyword">\l_tmpaa_tl</span><br><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpa_tl</span> &#123; A &#125;<br><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpaa_tl</span> &#123; <span class="hljs-keyword">\l_tmpa_tl</span> &#125;<br><span class="hljs-keyword">\tl_set:Nn</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#123; B &#125;<br><span class="hljs-comment">% &#x27;x&#x27; type</span><br><span class="hljs-keyword">\tl_set:Nx</span> <span class="hljs-keyword">\l_tmpc_tl</span> &#123; <span class="hljs-keyword">\l_tmpaa_tl</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#125;<br><span class="hljs-keyword">\quad</span><span class="hljs-keyword">\;</span>(`x&#x27;-expand)<span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpc_tl</span><span class="hljs-keyword">\par</span><br><br><span class="hljs-comment">% &#x27;f&#x27; type expand</span><br><span class="hljs-keyword">\tl_set:Nf</span> <span class="hljs-keyword">\l_tmpc_tl</span> &#123; <span class="hljs-keyword">\l_tmpaa_tl</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#125;<br>(`f&#x27;-expand)<span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpc_tl</span><span class="hljs-keyword">\par</span><br><br><span class="hljs-comment">% expans step by step</span><br><span class="hljs-comment">% expand once</span><br><span class="hljs-keyword">\tl_set:No</span> <span class="hljs-keyword">\l_tmpc_tl</span> &#123; <span class="hljs-keyword">\l_tmpaa_tl</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#125;<br>(`o&#x27;-type~ once)<span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpc_tl</span><span class="hljs-keyword">\par</span><br><span class="hljs-comment">% expand twice</span><br><span class="hljs-keyword">\tl_set:No</span> <span class="hljs-keyword">\l_tmpc_tl</span> &#123; <span class="hljs-keyword">\l_tmpa_tl</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#125;<br>(`o&#x27;-type~ twice)<span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpc_tl</span><span class="hljs-keyword">\par</span><br><span class="hljs-comment">% expand third</span><br><span class="hljs-keyword">\tl_set:No</span> <span class="hljs-keyword">\l_tmpc_tl</span> &#123; <span class="hljs-keyword">\l_tmpa_tl</span> <span class="hljs-keyword">\l_tmpb_tl</span> &#125;<br>(`o&#x27;-type~ third)<span class="hljs-keyword">\cs_meaning:N</span> <span class="hljs-keyword">\l_tmpc_tl</span><br></code></pre></td></tr></table></figure>
<p>最终的结果为:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs latex">(‘x’-expand)macro:-&gt;AB<br>(‘f’-expand)macro:-&gt;A<span class="hljs-keyword">\l_tmpb_tl</span><br>(‘o’-type once)macro:-&gt;<span class="hljs-keyword">\l_tmpa_tl</span> <span class="hljs-keyword">\l_tmpb_tl</span><br>(‘o’-type twice)macro:-&gt;A<span class="hljs-keyword">\l_tmpb_tl</span><br>(‘o’-type third)macro:-&gt;A<span class="hljs-keyword">\l</span><span class="hljs-built_in">_</span>tmpb<span class="hljs-built_in">_</span>t<br></code></pre></td></tr></table></figure>
<p>所以把这个f-type 看作 (first) expansion 个人觉得还是比较好理解的.</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/LaTeX/" class="category-chain-item">LaTeX</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/expansion/" class="print-no-link">#expansion</a>
      
        <a href="/tags/protect/" class="print-no-link">#protect</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Expansion in TeX</div>
      <div>https://zongpingding.github.io/2024/06/14/expansion_in_TeX/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Eureka</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>June 14, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/06/14/create_macro_in_latex/" title="Create Macro in LaTeX">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Create Macro in LaTeX</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/05/29/mathematica_tip/" title="Mathematica Tip">
                        <span class="hidden-mobile">Mathematica Tip</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'zongpingding/Utterances');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'comment');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
